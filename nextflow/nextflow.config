// nextflow.config

params {
    // Input/Output
    input_dir = "test_data/ont_data"
    outdir = "results"
    
    // Resources
    threads = 30
    memory = '100.GB'
    
    // Filtlong parameters
    filtlong_min_length = 1000
    filtlong_keep_percent = 90
    filtlong_min_quality = 10
    
    // Flye parameters
    flye_mode = '--nano-raw'  // Options: --nano-raw, --nano-hq, --nano-corr, --pacbio-raw, --pacbio-hifi, --pacbio-corr
    flye_genome_size = '5m'   // Estimated genome size (e.g., 5m for 5MB, 2.6g for 2.6GB) - matches your data
    flye_iterations = 1       // Number of polishing iterations
    flye_meta = true          // Enable metagenome mode - pentru date mixed
    
    // MetaBAT2 parameters
    metabat2_min_contig = 2500      // Minimum contig length for binning
    metabat2_min_bin = 200000       // Minimum bin size
    
    // CONCOCT parameters
    concoct_min_contig = 1000       // Minimum contig length for binning
    concoct_chunk_size = 10000      // Chunk size for cutting contigs
    concoct_overlap_size = 0        // Overlap size for chunks
    
    // CheckM parameters
    checkm_extension = 'fa'         // File extension for bin files
    
    // Help parameter
    help = false
}

// Executor configuration for performance
executor {
    name = 'local'
    cpus = 30
    memory = '100 GB'
    queueSize = 8
}

// Process configuration
process {
    // Default settings
    cpus = { params.threads }
    memory = { params.memory }
    time = '50h'
    
    // Enable process parallelization
    maxForks = 4
    executor = 'local'
    
    // NanoPlot process
    withName: 'NANOPLOT' {
        cpus = 16
        memory = '32.GB'
        time = '6h'
        publishDir = [
            path: "${params.outdir}/01_QC/nanoplot",
            mode: 'copy'
        ]
    }
    
    // Filtlong process
    withName: 'FILTLONG' {
        cpus = 30
        memory = '64.GB'
        time = '4h'
        publishDir = [
            path: "${params.outdir}/02_filtered",
            mode: 'copy'
        ]
    }
    
    // Flye assembly process
    withName: 'FLYE' {
        cpus = 30
        memory = '80.GB'
        time = '12h'
        publishDir = [
            path: "${params.outdir}/03_assembly",
            mode: 'copy'
        ]
    }
    
    // MetaBAT2 binning process
    withName: 'METABAT2' {
        cpus = 30
        memory = '64.GB'
        time = '6h'
        publishDir = [
            path: "${params.outdir}/04_binning/metabat2",
            mode: 'copy'
        ]
    }
    
    // CONCOCT binning process
    withName: 'CONCOCT' {
        cpus = 30
        memory = '64.GB'
        time = '8h'
        publishDir = [
            path: "${params.outdir}/04_binning/concoct",
            mode: 'copy'
        ]
    }
    
    // CheckM quality assessment process
    withName: 'CHECKM.*' {
        cpus = 24
        memory = '48.GB'
        time = '4h'
        publishDir = [
            path: "${params.outdir}/05_quality",
            mode: 'copy'
        ]
    }
}

// Execution profiles
profiles {
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        docker.sudo = true
        
        process {
            withName: 'NANOPLOT' {
                container = 'quay.io/biocontainers/nanoplot:1.42.0--pyhdfd78af_0'
            }
            withName: 'FILTLONG' {
                container = 'staphb/filtlong:0.2.1'
            }
            withName: 'FLYE' {
                container = 'staphb/flye:2.9.2'
            }
            withName: 'METABAT2' {
                container = 'metabat/metabat:2.15'
            }
            withName: 'CONCOCT' {
                container = 'quay.io/biocontainers/concoct:1.1.0--py27h88e4a8a_0'
            }
            withName: 'CHECKM.*' {
                container = 'quay.io/biocontainers/checkm-genome:1.2.2--pyhdfd78af_1'
            }
        }
    }
}

// Reporting
timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/trace.txt"
    overwrite = true
}